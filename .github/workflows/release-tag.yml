name: Release from Tag

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Release from Tag
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Check if release already exists
        id: check_release
        run: |
          TAG_NAME="v${{ steps.get_version.outputs.VERSION }}"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${TAG_NAME}")
          if [ "$RESPONSE" = "200" ]; then
            echo "RELEASE_EXISTS=true" >> $GITHUB_OUTPUT
          else
            echo "RELEASE_EXISTS=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Build for Linux x86_64
        if: steps.check_release.outputs.RELEASE_EXISTS == 'false'
        run: cargo build --release
      
      - name: Create release archive Linux x86_64
        if: steps.check_release.outputs.RELEASE_EXISTS == 'false'
        run: |
          chmod +x target/release/bashers
          tar czf bashers-linux-x86_64.tar.gz -C target/release bashers
      
      - name: Prepare install script
        if: steps.check_release.outputs.RELEASE_EXISTS == 'false'
        run: |
          sed -i "s|Sung96kim/bashers|${{ github.repository }}|g" install.sh
          chmod +x install.sh
      
      - name: Create GitHub Release
        if: steps.check_release.outputs.RELEASE_EXISTS == 'false'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            bashers-linux-x86_64.tar.gz
            install.sh
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: v${{ steps.get_version.outputs.VERSION }}
          body: |
            Release v${{ steps.get_version.outputs.VERSION }}
            
            ## Installation
            
            ### Quick Install (Recommended)
            ```bash
            curl -LsSf https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | sh
            ```
            
            ### From crates.io
            ```bash
            cargo install bashers
            ```
            
            ### Manual Installation
            ```bash
            tar xzf bashers-linux-x86_64.tar.gz
            sudo mv bashers /usr/local/bin/
            ```
            
            ### From Source
            ```bash
            cargo install --git https://github.com/${{ github.repository }}.git --tag v${{ steps.get_version.outputs.VERSION }}
            ```
